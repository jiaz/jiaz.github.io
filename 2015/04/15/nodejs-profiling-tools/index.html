<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node Profiling Tools | Jiaji&#39;s Blog</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
    
    <link rel="preload" href="/assets/css/0.styles.1f67bc9f.css" as="style"><link rel="preload" href="/assets/js/app.592312c9.js" as="script"><link rel="preload" href="/assets/js/4.66f2d894.js" as="script"><link rel="preload" href="/assets/js/5.96661c71.js" as="script"><link rel="preload" href="/assets/js/6.eb2ec798.js" as="script"><link rel="prefetch" href="/assets/js/1.005b66b8.js"><link rel="prefetch" href="/assets/js/10.c561e955.js"><link rel="prefetch" href="/assets/js/11.e3f5d2d1.js"><link rel="prefetch" href="/assets/js/12.cc21ebaf.js"><link rel="prefetch" href="/assets/js/13.0683d913.js"><link rel="prefetch" href="/assets/js/14.969c82c6.js"><link rel="prefetch" href="/assets/js/15.1a600f47.js"><link rel="prefetch" href="/assets/js/16.d03f686e.js"><link rel="prefetch" href="/assets/js/17.7a16a24f.js"><link rel="prefetch" href="/assets/js/18.eb6677b9.js"><link rel="prefetch" href="/assets/js/19.2c8c095d.js"><link rel="prefetch" href="/assets/js/20.c02f0e6e.js"><link rel="prefetch" href="/assets/js/7.1100521f.js"><link rel="prefetch" href="/assets/js/8.0008d7dc.js"><link rel="prefetch" href="/assets/js/9.e5bfcc2b.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b1a75fd5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1f67bc9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Jiaji's Blog</a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Jiaji's Blog</a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="node-profiling-tools"><a href="#node-profiling-tools" class="header-anchor">#</a> Node Profiling Tools</h1> <p>At Hulu, we use Nodejs to build a <strong>proxy</strong> or <strong>orchestration</strong> service to expose APIs to our client applications in order to provide a unified interface (in API schema) which hides the complexity to deal with our versatile backend &quot;micro-services&quot;.</p> <p>The reason we choose Nodejs over other technologies is that its <strong>asynchronized</strong> nature perfectly fits the requirements of the service:</p> <ul><li>Handling large number of concurrent clients;</li> <li>Requesting backend micro-services to get the data, where most of the time is spend on IO;</li> <li>Enhancing the backend response with data from other backend micro-services.</li></ul> <p>This is a typical front-tier API service that has <strong>low CPU</strong> consumption and <strong>high concurrent IO</strong> requirement.</p> <p>However when you deploy the application to production, it is very likely that you would hit CPU bottleneck if you are not careful enough when writing code. Javascript is so flexible that can easily get you trapped into performance problem if you don't understand the execution engine (v8) well enough. Recently, I spent a lot of time doing profiling and investigating the performance issues of our service.</p> <p>In this post, I'll list some tools and techniques I have used to profile/debug Nodejs program for daily development and production trouble-shooting as a summary of the work I've done.</p> <p>(We use MacOS X as development environment and Ubuntu server as production OS. The version of node we currently use is a custom build of v0.10.)</p> <h2 id="debugging-tools"><a href="#debugging-tools" class="header-anchor">#</a> Debugging Tools</h2> <h3 id="node-inspector"><a href="#node-inspector" class="header-anchor">#</a> node-inspector</h3> <p><a href="https://github.com/node-inspector/node-inspector" target="_blank" rel="noopener noreferrer">node-inspector<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is my favorite tool for Nodejs application trouble-shooting.</p> <p>You can use <code>node-debug</code> command to launch your application so that it starts your application and the debugger in your browser. However my favorite way to launch the debugger is to have a separate debugger process and attach node applications to it on demand so that I can use a single debugger process to debug multiple node applications.</p> <p>First launch node-inspector, I prefer to open a separate console and leave it there.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ node-inspector
Node Inspector v0.9.2
Visit http://127.0.0.1:8080/debug?port<span class="token operator">=</span><span class="token number">5858</span> to start debugging.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Then add <code>--debug</code> flag to the node option to run the node application with debugger enabled, which by default listen on port 5858. You can change the port by providing a port number to the debug flag, as <code>--debug=&lt;port&gt;</code>.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ node --debug lib/mozart_server.js
debugger listening on port <span class="token number">5858</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>If you try to debug some issue when node app starts, you can change <code>--debug</code> to <code>--debug-brk</code> so that your app starts in paused status.</p> <p>After your app is started, you can visit the URL <code>http://127.0.0.1:8080/debug?port=&lt;port&gt;</code> to debug your application, just like in any IDE.</p> <p><img src="/assets/img/node-inspector-1.eceebbe4.png" alt="node-inspector debugger"></p> <p>node-inspector can also be used remotely so that you can debug your applications on production servers.</p> <h3 id="webstorm-spy-js"><a href="#webstorm-spy-js" class="header-anchor">#</a> WebStorm (spy-js)</h3> <p>Recently I used <a href="https://www.jetbrains.com/webstorm/" target="_blank" rel="noopener noreferrer">WebStorm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> a lot for javascript development. People always debate about whether a good programmer should use IDE or plain text editor (especially VIM, emacs). I don't see any value in such debate, as a pragmatic developer, I just use the best tools I can find to get things done.</p> <p>WebStorm comes with a really good debugger for Nodejs applications based on their open source javascript tracing library <a href="https://github.com/spy-js/spy-js" target="_blank" rel="noopener noreferrer">spy-js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. With IDE's magic, you can start your server and set break points in the code in one place, the overall feature might be similar as node-inspector, but life gets much easier.</p> <p><img src="/assets/img/webstorm.d5f92ea7.png" alt="WebStorm debugger"></p> <p>Besides the debugger, it also has good IDE features like auto-completion, smart code inspection, refactor and code navigation. It definitely worth you $99 to get the tool if you do professional programming in javascript.</p> <h3 id="tracegl"><a href="#tracegl" class="header-anchor">#</a> TraceGL</h3> <p><a href="https://github.com/traceglMPL/tracegl" target="_blank" rel="noopener noreferrer">TraceGL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a tracing tool to log every statement your Nodejs app is executing. It is used when I want to know what exactly happens during the execution, especially when debugging timers, which is really difficult to manage using regular debuggers, because attaching the debugger will stop the execution and thus changing timers' behavior.</p> <p>TraceGL is very easy to setup, just clone the repository and follow instructions to build the <code>tracegl.js</code> lib, put it somewhere makes you comfortable to access, like <code>~/Workspace/tools/tracegl.js</code>. Then start your node application using the following command.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ node ~/Workspace/tools/tracegl lib/mozart_server.js
<span class="token punctuation">[</span>trace.GL<span class="token punctuation">]</span> See your code.
<span class="token punctuation">[</span>trace.GL<span class="token punctuation">]</span> WebGL trace UI: http://0.0.0.0:2000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Then open <code>http://localhost:2000</code> in your browser, you will see something like the below image. TraceGL outputs each executed statement in time order and the value of function arguments with the corresponding stack, which is really useful.</p> <p><img src="/assets/img/tracegl.72e9f55c.png" alt="TraceGL"></p> <h2 id="cpu-profiling"><a href="#cpu-profiling" class="header-anchor">#</a> CPU Profiling</h2> <p>Now let's talk about tools to profile your applications. During development it is critical to understand the bottleneck of your application, for any application that do serious business. Javascript programs can easily get slow and eating a lot of CPU if you don't pay attention. Even good professional programmers can get into these problems. So when such problem happen it's important to know how to find the culprit.</p> <h3 id="frame-graph"><a href="#frame-graph" class="header-anchor">#</a> Frame Graph</h3> <p>Frame Graph is the first thing I want to get when I start to find CPU bottlenecks. It gives you a good overview understanding of where your application spends most of the time. Below is a screen-shot of the Frame Graph of our application. I recently identified a lot of performance issues using this tool.</p> <p><img src="/assets/img/framechart.366f3ac6.png" alt="Frame Chart"></p> <p>Frame Graph is obtained by sampling your running program, getting the call stacks and accumulating them into the graph, in the graph:</p> <ul><li>The x-axis stands for the accumulated &quot;ticks&quot; of the sampled function. Each block represents a javascript function. The longer the block, the more CPU it (and its children) consumes. Although there is a time line in the chart, don't be cheated, the length of the block has no meaning in the real time perspective. Also the relative position of the bricks does not indicate the execution sequence. Blocks on the left are not necessarily executed before the blocks on the right.</li> <li>The y-axis stands for the depth of call stack. The higher the block, the deeper it is in the call stack. It also shows the parent-children relationship of the functions.</li></ul> <p>Most of the tutorials, blogs, articles I can find demand you to have some OS that support DTrace to generate this graph. Unfortunately, most of the time I work in Linux or MacOS, which has no full DTrace support. The good news is, it turns out that we don't need DTrace to get this! (as long as you only concern the javascript space, not inside v8 native space) node-inspector comes to the rescue again!</p> <p>Launch your node-inspector, boot up your server with debug flag and open the web debugger. See this &quot;Profiles&quot; tab? That's it!</p> <p><img src="/assets/img/node-inspector-profiler.9f5aa579.png" alt="node-inspector profiler"></p> <p>I won't spend more time to explain on how to use it though 😃 Just try it yourself.</p> <p>Moreover, node-inspector's sampling is really light-weight and it's very good for CPU bound performance tuning.</p> <h3 id="v8-profile-log"><a href="#v8-profile-log" class="header-anchor">#</a> v8 Profile log</h3> <p>Sometimes you need to do more subtle inspection, such as finding if the method is optimized or not by v8, knowing what Nodejs is doing in native space. Then you need the v8 profile log.</p> <p>To generate the v8 profile log is easy. Just add <code>--prof</code> to the node command line parameter.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ node --prof lib/mozart_server.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Then Nodejs will generate a file <code>v8.log</code> in the current folder.</p> <p>The difficult part is how to analyze the log file. According the tutorial, you need to find a proper <code>mac-tick-processor</code> to parse the log file. Unfortunately, I have never successfully built one, because the v8 version embedded in node v0.10 is too old and it just can't be built it in the latest OSX environment without changing the source code. That's painful.</p> <p>After some research, I found a particular useful tool called <a href="https://github.com/sidorares/node-tick" target="_blank" rel="noopener noreferrer">node-tick<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can do the trick. node-tick is a pure javascript application that doesn't require you to build. Below is an excerpt from the output of node-tick, which shows a suspicious unknown lib that consumes 15% of the CPU time.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>Unknown<span class="token punctuation">]</span>:
   ticks  total  nonlib   name
   <span class="token number">5790</span>   <span class="token number">14.9</span>%
 
 <span class="token punctuation">[</span>Shared libraries<span class="token punctuation">]</span>:
   ticks  total  nonlib   name
  <span class="token number">25474</span>   <span class="token number">65.7</span>%    <span class="token number">0.0</span>%  /Users/jiaji.zhou/.nvm/v0.10.24/bin/node
   <span class="token number">2634</span>    <span class="token number">6.8</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_kernel.dylib
   <span class="token number">1400</span>    <span class="token number">3.6</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_platform.dylib
    <span class="token number">716</span>    <span class="token number">1.8</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_c.dylib
    <span class="token number">537</span>    <span class="token number">1.4</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_malloc.dylib
    <span class="token number">232</span>    <span class="token number">0.6</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_pthread.dylib
     <span class="token number">33</span>    <span class="token number">0.1</span>%    <span class="token number">0.0</span>%  /usr/lib/libc++abi.dylib
     <span class="token number">13</span>    <span class="token number">0.0</span>%    <span class="token number">0.0</span>%  /usr/lib/system/libsystem_m.dylib
     <span class="token number">10</span>    <span class="token number">0.0</span>%    <span class="token number">0.0</span>%  /usr/lib/libstdc++.6.dylib
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>I'm not going to go into the details of how to understand the v8 log. Here are some references if you are interested:</p> <ul><li><a href="https://github.com/thlorenz/v8-perf/blob/master/performance-profiling.md" target="_blank" rel="noopener noreferrer">https://github.com/thlorenz/v8-perf/blob/master/performance-profiling.md<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://floitsch.blogspot.com/2012/03/optimizing-for-v8-memory-prof.html" target="_blank" rel="noopener noreferrer">http://floitsch.blogspot.com/2012/03/optimizing-for-v8-memory-prof.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="profiling-on-production"><a href="#profiling-on-production" class="header-anchor">#</a> Profiling on Production</h3> <p>Production is a serious business! Obviously, you should not add <code>--debug</code> flag to your process. Joyent has built a lot of tools that require DTrace functionality and their SmartOS to run well, but we are running Linux and I don't see any potential plan to change it to SmartOS, it sucks.</p> <p>There are some profiling and monitoring SaaS for Nodejs out there, such as <a href="https://nodetime.com" target="_blank" rel="noopener noreferrer">nodetime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://strongloop.com/node-js/performance-monitoring/" target="_blank" rel="noopener noreferrer">strongloop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://www.npmjs.com/package/pm2" target="_blank" rel="noopener noreferrer">PM2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, etc. I like none of them, because it not only will introduce an external network/service dependency but also will leak your production data to a 3rd party, which looks awkward and stupid if you are doing serious business.</p> <p>What we currently do is, setting up an environment as close to production as possible and constantly replaying production traffic to that environment, and using node-inspector to do profiling on that environment if necessary. Also we heavily rely on production metrics. We emit massive amount of metrics.</p> <p>Recently, I found a tool called <a href="https://github.com/uber/node-stap" target="_blank" rel="noopener noreferrer">node-stap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, developed by Uber, which looks promising. However SystemTap is intrusive and has impact on the system, I haven't tried it on production. I'm doing some experiments on it and might write a post about it later.</p> <h2 id="memory-profiling"><a href="#memory-profiling" class="header-anchor">#</a> Memory Profiling</h2> <h3 id="trace-gc-and-heap-size"><a href="#trace-gc-and-heap-size" class="header-anchor">#</a> Trace GC and Heap size</h3> <p>Nodejs has a pretty decent Garbage Collector, so usually you don't need to worry much about the GC parameters.</p> <p>A particular optimization we do on production is to enable <code>--expose-gc</code> and <code>--nouse-idle-notification</code> flag so that we can do manual GC when necessary. Here is a good reference about the effect of <code>--expose-gc</code> and <code>--nouse-idle-notification</code> to the system performance under high load: <a href="http://sysmagazine.com/posts/123154/" target="_blank" rel="noopener noreferrer">http://sysmagazine.com/posts/123154/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>On the other hand, GC activity log is a good resource for performance trouble shooting. It is better to record that. To enable GC log, you need to add the <code>--trace_gc</code> flag to the node command. See the below example. One thing to note: the number in the parenthesis is the total memory allocated, the number outside the parenthesis is the total used memory.</p> <p>When system performance is low, you may check the log to see if there are excessive GC events at the same time. If so, you may need to investigate how to reduce memory usage.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ node --debug --trace_gc --expose-gc lib/mozart_server.js
debugger listening on port <span class="token number">5858</span>
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>       <span class="token number">30</span> ms: Scavenge <span class="token number">2.0</span> <span class="token punctuation">(</span><span class="token number">34.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">1.7</span> <span class="token punctuation">(</span><span class="token number">36.0</span><span class="token punctuation">)</span> MB, <span class="token number">0</span> ms <span class="token punctuation">[</span>Runtime::PerformGC<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>       <span class="token number">42</span> ms: Scavenge <span class="token number">2.6</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.1</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> MB, <span class="token number">1</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>       <span class="token number">51</span> ms: Scavenge <span class="token number">3.1</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">2.5</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> MB, <span class="token number">0</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>       <span class="token number">67</span> ms: Scavenge <span class="token number">4.6</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">3.3</span> <span class="token punctuation">(</span><span class="token number">38.0</span><span class="token punctuation">)</span> MB, <span class="token number">0</span> ms <span class="token punctuation">[</span>Runtime::PerformGC<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>       <span class="token number">90</span> ms: Scavenge <span class="token number">5.5</span> <span class="token punctuation">(</span><span class="token number">39.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">4.5</span> <span class="token punctuation">(</span><span class="token number">39.0</span><span class="token punctuation">)</span> MB, <span class="token number">1</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">111</span> ms: Scavenge <span class="token number">6.4</span> <span class="token punctuation">(</span><span class="token number">39.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">5.4</span> <span class="token punctuation">(</span><span class="token number">40.0</span><span class="token punctuation">)</span> MB, <span class="token number">1</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">155</span> ms: Mark-sweep <span class="token number">9.4</span> <span class="token punctuation">(</span><span class="token number">41.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">5.6</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> MB, <span class="token number">8</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span> <span class="token punctuation">[</span>promotion limit reached<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">192</span> ms: Scavenge <span class="token number">10.2</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">7.4</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> MB, <span class="token number">1</span> ms <span class="token punctuation">[</span>Runtime::PerformGC<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">222</span> ms: Scavenge <span class="token number">10.8</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">8.7</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> MB, <span class="token number">2</span> ms <span class="token punctuation">[</span>Runtime::PerformGC<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">239</span> ms: Scavenge <span class="token number">12.6</span> <span class="token punctuation">(</span><span class="token number">44.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">10.9</span> <span class="token punctuation">(</span><span class="token number">46.0</span><span class="token punctuation">)</span> MB, <span class="token number">1</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">287</span> ms: Scavenge <span class="token number">18.1</span> <span class="token punctuation">(</span><span class="token number">46.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">13.2</span> <span class="token punctuation">(</span><span class="token number">47.0</span><span class="token punctuation">)</span> MB, <span class="token number">2</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">94062</span><span class="token punctuation">]</span>      <span class="token number">341</span> ms: Mark-sweep <span class="token number">19.7</span> <span class="token punctuation">(</span><span class="token number">47.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">12.3</span> <span class="token punctuation">(</span><span class="token number">48.0</span><span class="token punctuation">)</span> MB, <span class="token number">17</span> ms <span class="token punctuation">[</span>allocation failure<span class="token punctuation">]</span> <span class="token punctuation">[</span>promotion limit reached<span class="token punctuation">]</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>To understand the GC space layout, you may add <code>--trace_gc_verbose</code> to show details for the size of each generation. This is useful when the problem you need to solve is subtle and you need to understand the distribution of new generation and old generation. For example:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span>      <span class="token number">323</span> ms: Scavenge <span class="token number">10.8</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> <span class="token number">8.7</span> <span class="token punctuation">(</span><span class="token number">43.0</span><span class="token punctuation">)</span> MB, <span class="token number">2</span> ms <span class="token punctuation">[</span>Runtime::PerformGC<span class="token punctuation">]</span>.
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Memory allocator,   used:  <span class="token number">44048</span> KB, available: <span class="token number">1455088</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> New space,          used:    <span class="token number">917</span> KB, available:   <span class="token number">3178</span> KB, committed:   <span class="token number">8192</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Old pointers,       used:   <span class="token number">3249</span> KB, available:    <span class="token number">278</span> KB, committed:   <span class="token number">3535</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Old data space,     used:   <span class="token number">2795</span> KB, available:    <span class="token number">106</span> KB, committed:   <span class="token number">3215</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Code space,         used:   <span class="token number">1362</span> KB, available:    <span class="token number">115</span> KB, committed:   <span class="token number">1992</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Map space,          used:    <span class="token number">562</span> KB, available:    <span class="token number">573</span> KB, committed:   <span class="token number">1135</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Cell space,         used:     <span class="token number">39</span> KB, available:      <span class="token number">0</span> KB, committed:    <span class="token number">128</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Large object space, used:      <span class="token number">0</span> KB, available: <span class="token number">1454047</span> KB, committed:      <span class="token number">0</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> All spaces,         used:   <span class="token number">8926</span> KB, available:   <span class="token number">4251</span> KB, committed:  <span class="token number">18198</span> KB
<span class="token punctuation">[</span><span class="token number">93955</span><span class="token punctuation">]</span> Total <span class="token function">time</span> spent <span class="token keyword">in</span> GC  <span class="token builtin class-name">:</span> <span class="token number">12</span> ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Here is a good article about how GC works in Nodejs: <a href="https://strongloop.com/strongblog/node-js-performance-garbage-collection/" target="_blank" rel="noopener noreferrer">https://strongloop.com/strongblog/node-js-performance-garbage-collection/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Another common metric we monitor is the heap size, which can be obtained by calling <code>process.memoryUsage().heapUsed</code>.</p> <h3 id="profiling-on-production-2"><a href="#profiling-on-production-2" class="header-anchor">#</a> Profiling on Production</h3> <p>Sometimes, you may find abnormal memory usage on production. There is a good library to get heap dump on production: <a href="https://github.com/bnoordhuis/node-heapdump" target="_blank" rel="noopener noreferrer">heapdump<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. You can require heapdump in you application and send signal to your process to get heap dump when necessary. This is extremely useful to investigate problems on production.</p> <p>After you get the heap dump, you can use Chrome browser to load the dump and do comparison between different dumps to find potential memory leaks. See below image as an example.</p> <p><img src="/assets/img/heapdump.2873f5ec.png" alt="heapdump"></p> <h2 id="general-nodejs-performance-investigation-strategy"><a href="#general-nodejs-performance-investigation-strategy" class="header-anchor">#</a> General Nodejs Performance Investigation Strategy</h2> <p>With the above tools and utilities, you should have enough power to investigate Nodejs performance problems. Here are some general strategies you can follow.</p> <ul><li><strong>Find the bottleneck.</strong> First of all you need to understand what's the bottleneck of your system. Is it bandwidth, memory or CPU?</li> <li><strong>Focus on a single code path at a time.</strong> After you know your bottleneck, try to use some consistent way to stress your system and using the profiling tools to get the idea why the system is under perform in such fixed condition. As an example, we have a lot of API endpoints in our Nodejs service. When I do performance investigation, I will first find the slowest endpoint. Then focus on that endpoint to start investigation.</li> <li><strong>Start from the most significant issue.</strong> If some function takes 50% of your server's resource (CPU), when you optimize it by 30%, you get 15% total increase. On the other hand, if some function only takes 10% of your total resource, even if you totally eliminate the function, you still can only get 10%. So focus on most significant issue first.</li> <li><strong>Divide and Conquer.</strong> Most of the time the problem you are solving is too complex, so you need to break down the problem into small problems. Writing small benchmark scripts to understand how you can improve for each small problem.</li> <li><strong>Metric, metric, metric!</strong> On production, there is limited way to get information from your nodejs application. So please report as many metrics as possible when you write code. However please also profile how much cost you spend on reporting metrics, sometimes you may find it's ridiculously high, then you need to find a way to optimize the reporting.</li></ul></div> <hr> <!----></div></div></div> <footer class="footer" data-v-7966ce63><div class="footer-left-wrap" data-v-7966ce63><ul class="contact" data-v-7966ce63><li class="contact-item" data-v-7966ce63><a href="https://github.com/jiaz" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-7966ce63><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-7966ce63><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-7966ce63></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-7966ce63><ul class="copyright" data-v-7966ce63></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.592312c9.js" defer></script><script src="/assets/js/4.66f2d894.js" defer></script><script src="/assets/js/5.96661c71.js" defer></script><script src="/assets/js/6.eb2ec798.js" defer></script>
  </body>
</html>
