<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>A Simple HTTP Load Testing Client in Go | Jiaji&#39;s Blog</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
    
    <link rel="preload" href="/assets/css/0.styles.1f67bc9f.css" as="style"><link rel="preload" href="/assets/js/app.592312c9.js" as="script"><link rel="preload" href="/assets/js/4.66f2d894.js" as="script"><link rel="preload" href="/assets/js/5.96661c71.js" as="script"><link rel="preload" href="/assets/js/18.eb6677b9.js" as="script"><link rel="prefetch" href="/assets/js/1.005b66b8.js"><link rel="prefetch" href="/assets/js/10.c561e955.js"><link rel="prefetch" href="/assets/js/11.e3f5d2d1.js"><link rel="prefetch" href="/assets/js/12.cc21ebaf.js"><link rel="prefetch" href="/assets/js/13.0683d913.js"><link rel="prefetch" href="/assets/js/14.969c82c6.js"><link rel="prefetch" href="/assets/js/15.1a600f47.js"><link rel="prefetch" href="/assets/js/16.d03f686e.js"><link rel="prefetch" href="/assets/js/17.7a16a24f.js"><link rel="prefetch" href="/assets/js/19.2c8c095d.js"><link rel="prefetch" href="/assets/js/20.c02f0e6e.js"><link rel="prefetch" href="/assets/js/6.eb2ec798.js"><link rel="prefetch" href="/assets/js/7.1100521f.js"><link rel="prefetch" href="/assets/js/8.0008d7dc.js"><link rel="prefetch" href="/assets/js/9.e5bfcc2b.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.b1a75fd5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1f67bc9f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuperess-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Jiaji's Blog</a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Jiaji's Blog</a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuperess-theme-blog__post-layout"><div class="vuepress-blog-theme-content"><div class="content__default"><h1 id="a-simple-http-load-testing-client-in-go"><a href="#a-simple-http-load-testing-client-in-go" class="header-anchor">#</a> A Simple HTTP Load Testing Client in Go</h1> <h2 id="the-problem"><a href="#the-problem" class="header-anchor">#</a> The Problem</h2> <p>Last week we try to reproduce an incident in our production system which is caused by an eleviation of HTTPS connection creation rate. The service was flooded by more than 2000 concurrent connections per server at peak. We then tried to use apache benchmark (ab) to reproduce the issue in a local environment. However we found that although ab allows you to specify a concurrency level by using <code>-c</code> flag, it actually cannot reach that amount of concurrency because ab will hit the server's QPS bottleneck first and stop generating more concurrent connections.</p> <p>What we want is a load testing client that can serve limited QPS at high concurrent level.</p> <p>I know there are <a href="https://github.com/tsenart/vegeta" target="_blank" rel="noopener noreferrer">several<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://www.joedog.org/siege-home/" target="_blank" rel="noopener noreferrer">existing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/tarekziade/boom" target="_blank" rel="noopener noreferrer">tools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that can tweak QPS/delay and concurrency, but I had some bad experience on these tools before, either for performance or stability season and I don't want to waste time to learn and try them one by one, which probably would take me 2-3 hours to find a suitable one. Since the requirement is really simple, I decided to work on my own solution.</p> <h2 id="the-solution"><a href="#the-solution" class="header-anchor">#</a> The Solution</h2> <p>I've never written such a tool before so I basically have no preference on which platform I use to implement it. I think Go should be good at modeling concurrency so I decided to give it a try.</p> <p>I found goroutine a very natural way for modeling concurrent connections. So here is how to generate concurrent connections. (Please note that the code is not runnable since I picked them from the whole program. I'll provide a link to the full source code in the end of this post.)</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token operator">*</span>concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token function">sendRequest</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token operator">*</span>req<span class="token punctuation">,</span> <span class="token operator">*</span>concurrency<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>Here <code>concurrency</code> and <code>req</code> are input parameters to the program given by command line.</p> <p>However these goroutines will generate requests as quick as possible so we need a way to limit the QPS. I used a buffered channel as a blocking queue to generate tokens for sending requests, then all client goroutines are required to get the token first then sending the request. Also setup a separate goroutine to constantly fill in the token queue to allow more requests to be generated. Here is the code:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>bucket <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token operator">*</span>maxQPS<span class="token punctuation">)</span>

<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token operator">*</span>maxQPS<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token keyword">select</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> bucket <span class="token operator">&lt;-</span> <span class="token boolean">true</span><span class="token punctuation">:</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	

<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token operator">*</span>concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">{</span>
            <span class="token operator">&lt;-</span> bucket
            <span class="token function">sendRequest</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token operator">*</span>req<span class="token punctuation">,</span> <span class="token operator">*</span>concurrency<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>Here I used the <code>select..default</code> construct to cancel adding tokens to the queue if the queue is full to avoid token generator  generating more tokens than wanted under race condition.</p> <p>That's it! The basic functionality is done!</p> <h3 id="workaround-time-wait-connection-problem"><a href="#workaround-time-wait-connection-problem" class="header-anchor">#</a> Workaround <code>TIME_WAIT</code> connection problem</h3> <p>Because we want to test the scenario that clients keep generating new connections to the server, we specifically disabled keep-alive for the underlying connection. After running the program for a while we found that the client used up the IP port range reserved for client connection which is roughly 28k ports. The result is that on the client host, you observe a lot of TCP connections in <code>TIME_WAIT</code> state. This is an expected behavior of TCP connections. I did the following trick to workaround the problem:</p> <ul><li><strong>Tweak the OS configuration on the running host.</strong> We run the client on a Linux server, you can follow <a href="http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html" target="_blank" rel="noopener noreferrer">this article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to set <code>net.ipv4.tcp_tw_reuse</code> to <code>1</code>.</li> <li><strong>Change the Dial of http.Transport to use <code>TCPConn.SetLinger(0)</code>.</strong> Tweaking the network configuration is not enough, we also have to change the client's TCP connection to set <code>SO_LINGER</code> to <code>0</code> when create connections. See <a href="http://stackoverflow.com/questions/3757289/tcp-option-so-linger-zero-when-its-required" target="_blank" rel="noopener noreferrer">this article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for detailed explanation.</li></ul> <p>After all these tweak, the performance of the final tool is really good, I can generate 200 concurrent connection with 400 max QPS using a single 2.4G Hz Xeon core.</p> <p>Another beautiful feature of Go is that you can develop in your Mac OS and directly cross compile a Linux working binary on your Dev machine and deploy-by-copying-a-single-file. Sweet!</p> <p>You can checkout the full working source code here: <a href="https://github.com/jiaz/simpleloadclient" target="_blank" rel="noopener noreferrer">https://github.com/jiaz/simpleloadclient<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>Go is really good at modeling concurrencies. I can't imagine how many code I need to write to implement this tool in other language. In fact, I don't like Go for its lack of Generics and duck typing only type system. There are <a href="http://www.quora.com/What-reasons-are-there-to-not-use-Go-programming-language" target="_blank" rel="noopener noreferrer">a lot of<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://www.quora.com/Do-you-feel-that-golang-is-ugly" target="_blank" rel="noopener noreferrer">criticism of Go<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and some of which are quite reasonable. However, despite the fact that it is not perfect, it is really sharp for the concurrency modeling. As a developer, we should open our mind by learning these different views to the world so that we can model our problems better with more suitable tools.</p> <p>TCP connection tweaking is interesting. I've seen the <code>TIME_WAIT</code> problem a lot before in production service development. You need to understand TCP states pretty well to implement a decent performing service.</p></div> <hr> <!----></div></div></div> <footer class="footer" data-v-7966ce63><div class="footer-left-wrap" data-v-7966ce63><ul class="contact" data-v-7966ce63><li class="contact-item" data-v-7966ce63><a href="https://github.com/jiaz" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-7966ce63><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-7966ce63><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-7966ce63></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-7966ce63><ul class="copyright" data-v-7966ce63></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.592312c9.js" defer></script><script src="/assets/js/4.66f2d894.js" defer></script><script src="/assets/js/5.96661c71.js" defer></script><script src="/assets/js/18.eb6677b9.js" defer></script>
  </body>
</html>
